# 01. 文本编码 (Text Encoding)

## 流程图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              文本编码流程                                            │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│                          ┌───────────────────┐                                      │
│                          │     用户文本       │                                      │
│                          │ "A cat playing    │                                      │
│                          │  with a ball"     │                                      │
│                          └─────────┬─────────┘                                      │
│                                    │                                                │
│                    ┌───────────────┴───────────────┐                                │
│                    │                               │                                │
│                    ▼                               ▼                                │
│   ┌─────────────────────────────┐   ┌─────────────────────────────┐                 │
│   │         T5 Encoder          │   │       CLIP Encoder          │                 │
│   ├─────────────────────────────┤   ├─────────────────────────────┤                 │
│   │ 模型: google/t5-v1_1-xxl    │   │ 模型: openai/clip-vit-large │                 │
│   │ 或: t5-small (测试)         │   │ 或: clip-base (测试)        │                 │
│   │                             │   │                             │                 │
│   │ 功能: 语义理解              │   │ 功能: 全局语义              │                 │
│   │ - 长文本支持                │   │ - 图文对齐                  │                 │
│   │ - 序列级别特征              │   │ - 全局向量表示              │                 │
│   │                             │   │                             │                 │
│   │ max_length: 512 tokens      │   │ max_length: 77 tokens       │                 │
│   └──────────────┬──────────────┘   └──────────────┬──────────────┘                 │
│                  │                                 │                                │
│                  ▼                                 ▼                                │
│   ┌─────────────────────────────┐   ┌─────────────────────────────┐                 │
│   │           txt               │   │          y_vec              │                 │
│   │   [B, seq_len, context_dim] │   │       [B, vec_dim]          │                 │
│   │                             │   │                             │                 │
│   │ 正式: [B, 512, 4096]        │   │ 正式: [B, 768]              │                 │
│   │ 测试: [B, 512, 512]         │   │ 测试: [B, 512]              │                 │
│   └──────────────┬──────────────┘   └──────────────┬──────────────┘                 │
│                  │                                 │                                │
│                  └─────────────┬───────────────────┘                                │
│                                │                                                    │
│                                ▼                                                    │
│                  ┌─────────────────────────────┐                                    │
│                  │       传入 MMDiT 模型        │                                    │
│                  │  txt → txt_in → 文本流       │                                    │
│                  │  y_vec → vector_in → vec    │                                    │
│                  └─────────────────────────────┘                                    │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 输入/输出规格

### 输入
| 参数 | 类型 | 描述 | 示例 |
|------|------|------|------|
| `text` | `list[str]` | 文本提示列表 | `["A cat playing with a ball"]` |
| `neg` | `list[str]` \| `None` | 负面提示（可选） | `["blurry, low quality"]` |

### 输出
| 参数 | 形状 | 描述 |
|------|------|------|
| `txt` | `[B, seq_len, context_dim]` | T5 编码的序列特征 |
| `y_vec` | `[B, vec_dim]` | CLIP 编码的全局向量 |

## 关键代码

```python
# 位置: opensora/utils/sampling.py - prepare() 函数

def prepare(t5, clip, img, prompt, seq_align=1, patch_size=2):
    # T5 编码: 获取序列级别特征
    # added_tokens 用于对齐图像序列长度
    txt = t5(prompt, added_tokens=img_ids.shape[1], seq_align=seq_align)
    # 输出: [B, max_length, 4096] (T5-xxl)
    
    # CLIP 编码: 获取全局向量
    vec = clip(prompt)
    # 输出: [B, 768] (CLIP-large)
    
    return {
        "txt": txt,      # 传入 DoubleStreamBlock 的文本流
        "y_vec": vec,    # 用于时间步调制
        ...
    }
```

## T5 vs CLIP 的作用区别

```
┌───────────────────────────────────────────────────────────────────────────┐
│                        两个编码器的协同作用                                │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│   T5 (序列编码器)                     CLIP (全局编码器)                    │
│   ─────────────────                   ───────────────────                  │
│                                                                           │
│   "A cat playing with a ball"         "A cat playing with a ball"         │
│         │                                      │                          │
│         ▼                                      ▼                          │
│   ┌─────────────────┐                 ┌─────────────────┐                 │
│   │ Token-by-Token  │                 │   Pooled CLS    │                 │
│   │   Embeddings    │                 │    Embedding    │                 │
│   │                 │                 │                 │                 │
│   │ [A]  [cat]      │                 │    [global]     │                 │
│   │ [playing]       │                 │     vector      │                 │
│   │ [with] [a]      │                 │                 │                 │
│   │ [ball]          │                 │                 │                 │
│   └────────┬────────┘                 └────────┬────────┘                 │
│            │                                   │                          │
│            ▼                                   ▼                          │
│   ┌─────────────────┐                 ┌─────────────────┐                 │
│   │  Cross-Attention│                 │ Timestep 调制   │                 │
│   │  与图像交互      │                 │ vec = time + y  │                 │
│   │                 │                 │                 │                 │
│   │ 图像的每个patch │                 │ 影响全局风格    │                 │
│   │ attend到相关词  │                 │ 和生成方向      │                 │
│   └─────────────────┘                 └─────────────────┘                 │
│                                                                           │
│   用途: 细粒度语义对齐                 用途: 全局条件控制                  │
│   例如: "cat" 对应猫的位置             例如: 整体画风、主题                │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

## Classifier-Free Guidance (CFG) 准备

在 I2V 模式下，会准备三组文本嵌入用于 CFG：

```python
# 位置: opensora/utils/sampling.py - I2VDenoiser.prepare_guidance()

def prepare_guidance(self, text, ...):
    if neg is None:
        neg = [""] * len(text)  # 空文本作为负面提示
    
    # 三组文本用于三路 CFG
    text = text + neg + neg
    # text[0:B]    -> 正向文本 (有条件)
    # text[B:2B]   -> 负面文本 (文本无条件)
    # text[2B:3B]  -> 负面文本 (图像也无条件)
    
    return text, {}
```

CFG 公式：
```
pred = uncond_2 + image_gs * (uncond - uncond_2) + text_gs * (cond - uncond)

其中:
- cond:    正向文本条件的预测
- uncond:  文本无条件的预测（仍有图像条件）
- uncond_2: 完全无条件的预测
```

## 配置对比

| 参数 | dummy_test.py (测试) | image.py (正式) |
|------|---------------------|-----------------|
| T5 模型 | `t5-small` (60M参数) | `t5-v1_1-xxl` (11B参数) |
| T5 输出维度 | 512 | 4096 |
| CLIP 模型 | `clip-base` | `clip-vit-large-patch14` |
| CLIP 输出维度 | 512 | 768 |
| ShardFormer | `False` | `True` (模型并行) |
