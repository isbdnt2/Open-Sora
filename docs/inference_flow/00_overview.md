# Open-Sora 完整推理流程概览

## 总体架构图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            Open-Sora 推理流程                                        │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│   ┌──────────────┐                                                                  │
│   │   用户输入    │                                                                  │
│   │  - 文本提示   │                                                                  │
│   │  - 参考图片   │                                                                  │
│   │  - 采样参数   │                                                                  │
│   └──────┬───────┘                                                                  │
│          │                                                                          │
│          ▼                                                                          │
│   ┌──────────────────────────────────────────────────────────────────────────────┐  │
│   │                        01_text_encoding.md                                   │  │
│   │  ┌────────────┐              ┌────────────┐                                  │  │
│   │  │    T5      │              │   CLIP     │                                  │  │
│   │  │  Encoder   │              │  Encoder   │                                  │  │
│   │  │(xxl/small) │              │(large/base)│                                  │  │
│   │  └─────┬──────┘              └─────┬──────┘                                  │  │
│   │        │                           │                                         │  │
│   │        ▼                           ▼                                         │  │
│   │   txt [B, 512, 4096]         y_vec [B, 768]                                  │  │
│   └──────────────────────────────────────────────────────────────────────────────┘  │
│          │                           │                                              │
│          ▼                           ▼                                              │
│   ┌──────────────────────────────────────────────────────────────────────────────┐  │
│   │                        02_noise_initialization.md                            │  │
│   │  生成初始噪声 z ~ N(0, 1)                                                     │  │
│   │  输出: z [B, 16, T', H', W']                                                 │  │
│   │                                                                              │  │
│   │  注: T'=T (时间不压缩), H'=H/8, W'=W/8 (空间压缩8倍)                          │  │
│   └──────────────────────────────────────────────────────────────────────────────┘  │
│          │                                                                          │
│          ▼                                                                          │
│   ┌──────────────────────────────────────────────────────────────────────────────┐  │
│   │                        03_prepare_inputs.md                                  │  │
│   │  - Patchify: z → img [B, N, C]                                               │  │
│   │  - 生成位置 IDs: img_ids, txt_ids                                            │  │
│   │  - 准备条件 (I2V): masks, masked_ref                                         │  │
│   └──────────────────────────────────────────────────────────────────────────────┘  │
│          │                                                                          │
│          ▼                                                                          │
│   ┌──────────────────────────────────────────────────────────────────────────────┐  │
│   │                        04_denoising_loop.md                                  │  │
│   │  for t in timesteps:                                                         │  │
│   │      ┌─────────────────────────────────────────────────────────────────┐     │  │
│   │      │                    05_mmdit_forward.md                          │     │  │
│   │      │  DoubleStreamBlock × depth                                      │     │  │
│   │      │  SingleStreamBlock × depth_single_blocks                        │     │  │
│   │      │  → 预测噪声/速度 pred                                            │     │  │
│   │      └─────────────────────────────────────────────────────────────────┘     │  │
│   │      img = img + (t_prev - t_curr) * pred  (Euler 更新)                      │  │
│   └──────────────────────────────────────────────────────────────────────────────┘  │
│          │                                                                          │
│          ▼                                                                          │
│   ┌──────────────────────────────────────────────────────────────────────────────┐  │
│   │                        06_vae_decode.md                                      │  │
│   │  Unpack: img [B, N, C] → x [B, 16, T', H', W']                               │  │
│   │  VAE Decode: x → video [B, 3, T, H, W]                                       │  │
│   └──────────────────────────────────────────────────────────────────────────────┘  │
│          │                                                                          │
│          ▼                                                                          │
│   ┌──────────────┐                                                                  │
│   │   输出视频    │                                                                  │
│   │ [B, 3, T, H, W]                                                                 │
│   └──────────────┘                                                                  │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 文件列表

| 文件名 | 描述 |
|--------|------|
| `00_overview.md` | 总体流程概览（本文件） |
| `01_text_encoding.md` | 文本编码（T5 + CLIP） |
| `02_noise_initialization.md` | 噪声初始化与时间步调度 |
| `03_prepare_inputs.md` | 输入准备（Patchify + 位置编码） |
| `04_denoising_loop.md` | 去噪循环 |
| `05_mmdit_forward.md` | MMDiT 模型前向传播 |
| `06_vae_decode.md` | VAE 解码输出视频 |

## 关键代码入口

- **推理脚本**: `scripts/diffusion/inference.py`
- **采样核心**: `opensora/utils/sampling.py`
- **模型定义**: `opensora/models/mmdit/model.py`
