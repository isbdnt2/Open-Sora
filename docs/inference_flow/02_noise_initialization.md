# 02. 噪声初始化与时间步调度 (Noise Initialization & Timestep Schedule)

## 流程图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                         噪声初始化与时间步调度                                        │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                          1. 噪声初始化                                       │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                             │   │
│   │   输入参数                        生成高斯噪声                               │   │
│   │   ┌─────────────────┐            ┌─────────────────────────────────┐        │   │
│   │   │ num_samples: B  │            │                                 │        │   │
│   │   │ height: H       │     →      │    z ~ N(0, 1)                  │        │   │
│   │   │ width: W        │            │                                 │        │   │
│   │   │ num_frames: T'  │            │    shape: [B, C, T', H', W']    │        │   │
│   │   │ seed: 1024      │            │                                 │        │   │
│   │   │ channel: 16     │            │    例: [1, 16, 5, 32, 32]       │        │   │
│   │   └─────────────────┘            └─────────────────────────────────┘        │   │
│   │                                                                             │   │
│   │   注意: T' 是 VAE 压缩后的时间维度                                           │   │
│   │         T' = (T - 1) / temporal_reduction + 1  (causal VAE)                 │   │
│   │         H' = H / spatial_compression / patch_size                           │   │
│   │         W' = W / spatial_compression / patch_size                           │   │
│   │                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                          2. 时间步调度                                       │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                             │   │
│   │   基础时间步                    时间偏移 (Time Shift)                        │   │
│   │                                                                             │   │
│   │   timesteps = linspace(1, 0, num_steps+1)                                   │   │
│   │                                                                             │   │
│   │   [1.0, 0.98, 0.96, ..., 0.02, 0.0]  (51个点, 50步)                         │   │
│   │     │                                                                       │   │
│   │     ▼                                                                       │   │
│   │   ┌─────────────────────────────────────────────────────────────────┐       │   │
│   │   │              Time Shift (时间偏移)                              │       │   │
│   │   │                                                                 │       │   │
│   │   │   shifted_t = α * t / (1 + (α - 1) * t)                        │       │   │
│   │   │                                                                 │       │   │
│   │   │   α = f(image_seq_len) * sqrt(num_frames)                      │       │   │
│   │   │                                                                 │       │   │
│   │   │   作用: 高分辨率/长视频需要更多高噪声时间步                      │       │   │
│   │   └─────────────────────────────────────────────────────────────────┘       │   │
│   │                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                          3. 时间偏移可视化                                   │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                             │   │
│   │   噪声程度                                                                  │   │
│   │   1.0 ┤●                                                                    │   │
│   │       │ ●                                                                   │   │
│   │       │  ●●                                                                 │   │
│   │       │    ●●●                                                              │   │
│   │   0.5 ┤       ●●●●●                (原始线性)                               │   │
│   │       │            ●●●●●●●●●                                                │   │
│   │       │                     ●●●●●●●●●●●●                                    │   │
│   │   0.0 ┤                                   ●●●●●●●●●●●●●                     │   │
│   │       └────────────────────────────────────────────────► 采样步骤           │   │
│   │       0                    25                         50                    │   │
│   │                                                                             │   │
│   │   1.0 ┤●●●●●                                                                │   │
│   │       │     ●●●●●●                                                          │   │
│   │       │           ●●●●●●                                                    │   │
│   │       │                 ●●●●●             (带偏移，α=3)                     │   │
│   │   0.5 ┤                      ●●●●                                           │   │
│   │       │                          ●●●●                                       │   │
│   │       │                              ●●●                                    │   │
│   │   0.0 ┤                                 ●●●●●●●●●●●●●●●                     │   │
│   │       └────────────────────────────────────────────────► 采样步骤           │   │
│   │       0                    25                         50                    │   │
│   │                                                                             │   │
│   │   偏移效果: 在高噪声区域花更多时间步，改善结构生成                            │   │
│   │                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 输入/输出规格

### 噪声初始化

| 输入参数 | 类型 | 描述 |
|---------|------|------|
| `num_samples` | `int` | 批次大小 B |
| `height` | `int` | 目标高度（像素） |
| `width` | `int` | 目标宽度（像素） |
| `num_frames` | `int` | VAE 压缩后的帧数 T' |
| `seed` | `int` | 随机种子 |
| `channel` | `int` | 潜在空间通道数（默认16） |
| `patch_size` | `int` | Patch 大小（默认2） |

| 输出 | 形状 | 描述 |
|-----|------|------|
| `z` | `[B, C/patch², T', H'×patch, W'×patch]` | 初始噪声 |

### 时间步调度

| 输入参数 | 类型 | 描述 |
|---------|------|------|
| `num_steps` | `int` | 采样步数（默认50） |
| `image_seq_len` | `int` | 图像序列长度 |
| `num_frames` | `int` | 帧数 |
| `shift` | `bool` | 是否使用时间偏移 |
| `shift_alpha` | `float` \| `None` | 手动指定偏移系数 |

| 输出 | 类型 | 描述 |
|-----|------|------|
| `timesteps` | `list[float]` | 时间步列表，长度 num_steps+1 |

## 关键代码

### 噪声生成

```python
# 位置: opensora/utils/sampling.py

def get_noise(
    num_samples: int,
    height: int,
    width: int,
    num_frames: int,
    device: torch.device,
    dtype: torch.dtype,
    seed: int,
    patch_size: int = 2,
    channel: int = 16,
) -> Tensor:
    """生成初始高斯噪声"""
    D = int(os.environ.get("AE_SPATIAL_COMPRESSION", 16))  # 空间压缩比
    return torch.randn(
        num_samples,
        channel,                              # 16（实际存储为 16/patch²=4）
        num_frames,                           # VAE 压缩后的时间维度
        patch_size * math.ceil(height / D),   # 确保可被 patch 整除
        patch_size * math.ceil(width / D),    # 确保可被 patch 整除
        device=device,
        dtype=dtype,
        generator=torch.Generator(device=device).manual_seed(seed),
    )
```

### 时间步调度

```python
# 位置: opensora/utils/sampling.py

def time_shift(alpha: float, t: Tensor) -> Tensor:
    """时间偏移函数"""
    return alpha * t / (1 + (alpha - 1) * t)


def get_res_lin_function(x1=256, y1=1, x2=4096, y2=3):
    """根据分辨率计算偏移系数的线性函数"""
    m = (y2 - y1) / (x2 - x1)
    b = y1 - m * x1
    return lambda x: m * x + b


def get_schedule(
    num_steps: int,
    image_seq_len: int,
    num_frames: int,
    shift_alpha: float | None = None,
    base_shift: float = 1,
    max_shift: float = 3,
    shift: bool = True,
) -> list[float]:
    """生成时间步调度"""
    # 基础线性时间步
    timesteps = torch.linspace(1, 0, num_steps + 1)

    if shift:
        if shift_alpha is None:
            # 根据分辨率计算偏移系数
            shift_alpha = get_res_lin_function(y1=base_shift, y2=max_shift)(
                image_seq_len
            )
            # 根据帧数缩放
            shift_alpha *= math.sqrt(num_frames)
        
        # 应用时间偏移
        timesteps = time_shift(shift_alpha, timesteps)

    return timesteps.tolist()
```

## 时间偏移的数学原理

### Flow Matching 的时间步

在 Flow Matching 中，时间步 t ∈ [0, 1] 表示噪声程度：
- t = 1: 纯噪声
- t = 0: 干净数据

### 为什么需要时间偏移？

```
问题：线性时间步在高分辨率/长视频时效果不佳

原因：
- 高分辨率图像有更多细节需要生成
- 长视频需要更强的时序一致性
- 高噪声区域（t 接近 1）决定整体结构
- 低噪声区域（t 接近 0）只是微调细节

解决方案：时间偏移
- 在高噪声区域分配更多时间步
- 让模型有更多机会确定正确的结构
```

### 偏移系数 α 的计算

```python
# 空间分辨率影响
α_spatial = linear_interp(image_seq_len, 
                          (256, 1),    # 小图用 α=1
                          (4096, 3))   # 大图用 α=3

# 时间维度影响
α = α_spatial * sqrt(num_frames)

# 例如 1024px 视频，17帧：
# image_seq_len ≈ 64 * 64 = 4096
# α_spatial ≈ 3
# α = 3 * sqrt(5) ≈ 6.7
```

## 维度计算示例

假设生成 256×256 分辨率的 17 帧视频：

```
原始视频:
  [B, 3, T=17, H=256, W=256]

VAE 压缩后 (spatial: 8x, temporal: 4x for causal):
  T' = (17 - 1) / 4 + 1 = 5
  H' = 256 / 8 = 32
  W' = 256 / 8 = 32
  → [B, 16, 5, 32, 32]

生成噪声时 (patch_size=2):
  → [B, 16/4, 5, 32*2, 32*2] = [B, 4, 5, 64, 64]
  
  注意: get_noise 中 channel = channel // patch_size² = 16 // 4 = 4
        但空间维度乘以 patch_size，总元素数不变
```
