# 01. 数据加载 (Data Loading)

## 流程图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              数据加载流程                                            │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                          1. 数据集定义                                       │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                             │   │
│   │   配置文件 (YAML/Python):                                                   │   │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │   │
│   │   │  dataset = dict(                                                    │   │   │
│   │   │      type="VariableVideoTextDataset",                               │   │   │
│   │   │      data_path=["path/to/metadata.csv"],                            │   │   │
│   │   │      image_data_path=["path/to/image_meta.csv"],  # 可选图像数据    │   │   │
│   │   │      transform_name="resize_crop",                                  │   │   │
│   │   │  )                                                                  │   │   │
│   │   └─────────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                             │   │
│   │   数据格式 (CSV):                                                           │   │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │   │
│   │   │  path,text,num_frames,height,width                                  │   │   │
│   │   │  video1.mp4,"A dog running...",65,720,1280                          │   │   │
│   │   │  video2.mp4,"Ocean waves...",129,480,640                            │   │   │
│   │   └─────────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                          2. Bucket 配置                                      │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                             │   │
│   │   bucket_config = {                                                         │   │
│   │       "1:1": {                          # 宽高比                            │   │
│   │           256: {1: (1.0, 64), 17: (1.0, 16), 65: (0.5, 4)},                 │   │
│   │       #   ^分辨率  ^帧数  ^(采样权重, batch_size)                           │   │
│   │       },                                                                    │   │
│   │       "16:9": {                                                             │   │
│   │           240x426: {1: (1.0, 64), 17: (1.0, 8), 65: (0.5, 2)},              │   │
│   │       },                                                                    │   │
│   │   }                                                                         │   │
│   │                                                                             │   │
│   │   作用:                                                                     │   │
│   │   - 按分辨率和帧数对视频分桶                                                │   │
│   │   - 同一 batch 内视频形状相同，避免 padding                                 │   │
│   │   - 根据显存自动调整 batch size                                             │   │
│   │                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                          3. 数据采样流程                                     │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                             │   │
│   │   ┌───────────────────────────────────────────────────────────────────┐     │   │
│   │   │                     VariableBatchSampler                          │     │   │
│   │   │                                                                   │     │   │
│   │   │   1. 构建 Bucket 索引                                             │     │   │
│   │   │      ┌────────┐  ┌────────┐  ┌────────┐                           │     │   │
│   │   │      │ 256×256│  │ 240×426│  │ 480×854│                           │     │   │
│   │   │      │ 17帧   │  │ 17帧   │  │ 65帧   │                           │     │   │
│   │   │      │ bs=16  │  │ bs=8   │  │ bs=2   │                           │     │   │
│   │   │      └────────┘  └────────┘  └────────┘                           │     │   │
│   │   │                                                                   │     │   │
│   │   │   2. 按权重随机选择 Bucket                                        │     │   │
│   │   │                                                                   │     │   │
│   │   │   3. 从选中 Bucket 采样 batch_size 个样本                         │     │   │
│   │   │                                                                   │     │   │
│   │   │   4. 返回样本索引列表                                             │     │   │
│   │   │                                                                   │     │   │
│   │   └───────────────────────────────────────────────────────────────────┘     │   │
│   │                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                          4. 数据加载与预处理                                 │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                             │   │
│   │   原始视频                         预处理后                                 │   │
│   │   ┌─────────────┐                 ┌─────────────┐                           │   │
│   │   │  video.mp4  │  ──Transform──► │ [B,C,T,H,W] │                           │   │
│   │   │ (H×W×T×3)   │                 │ torch.Tensor│                           │   │
│   │   └─────────────┘                 └─────────────┘                           │   │
│   │                                                                             │   │
│   │   Transform 操作:                                                           │   │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │   │
│   │   │  1. 读取视频帧 (decord/cv2)                                         │   │   │
│   │   │  2. 时间采样: 按固定间隔或随机采样指定帧数                          │   │   │
│   │   │  3. 空间变换: Resize → CenterCrop/RandomCrop                        │   │   │
│   │   │  4. 归一化: [0,255] → [-1,1]                                        │   │   │
│   │   │  5. 维度重排: (T,H,W,C) → (C,T,H,W)                                 │   │   │
│   │   └─────────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                          5. DataLoader 输出                                  │   │
│   ├─────────────────────────────────────────────────────────────────────────────┤   │
│   │                                                                             │   │
│   │   batch = {                                                                 │   │
│   │       "video": Tensor[B, 3, T, H, W],   # RGB 视频                         │   │
│   │       "text": List[str],                 # 文本描述                         │   │
│   │   }                                                                         │   │
│   │                                                                             │   │
│   │   示例维度 (256×256, 17帧, bs=16):                                          │   │
│   │   - video: [16, 3, 17, 256, 256]                                            │   │
│   │   - text: ["A cat...", "Ocean...", ...] (16个字符串)                        │   │
│   │                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 输入/输出规格

### 数据集输入

| 输入 | 类型 | 描述 |
|-----|------|------|
| `data_path` | `List[str]` | CSV 元数据文件路径 |
| `image_data_path` | `List[str]` | 图像元数据路径（可选） |
| `transform_name` | `str` | 预处理方法名 |

### DataLoader 输出

| 输出 | 形状 | 描述 |
|-----|------|------|
| `video` | `[B, 3, T, H, W]` | 归一化后的视频张量，值域 [-1, 1] |
| `text` | `List[str]` | B 个文本描述字符串 |

## 关键代码

### 数据集定义

```python
# 位置: opensora/datasets/datasets.py

class VariableVideoTextDataset(Dataset):
    def __init__(
        self,
        data_path: list[str],
        image_data_path: list[str] = None,
        transform_name: str = "resize_crop",
        num_frames: int = None,  # 用于固定帧数模式
    ):
        self.data = self._load_metadata(data_path)
        self.transform = get_transforms(transform_name)
    
    def __getitem__(self, idx):
        row = self.data[idx]
        video = self._load_video(row["path"], row["num_frames"])
        video = self.transform(video)  # 空间/时间变换
        return {
            "video": video,
            "text": row["text"],
        }
```

### Bucket Sampler

```python
# 位置: opensora/datasets/sampler.py

class VariableBatchSampler(Sampler):
    def __init__(
        self,
        dataset,
        bucket_config: dict,
        num_replicas: int = 1,
        rank: int = 0,
    ):
        # 构建 bucket -> sample_indices 映射
        self.buckets = self._build_buckets(dataset, bucket_config)
        # 计算每个 bucket 的采样权重
        self.weights = self._compute_weights(bucket_config)
    
    def __iter__(self):
        while True:
            # 按权重随机选择一个 bucket
            bucket_key = random.choices(
                list(self.buckets.keys()),
                weights=self.weights,
            )[0]
            # 从该 bucket 采样 batch_size 个样本
            batch_size = self.bucket_config[bucket_key]["batch_size"]
            indices = random.sample(self.buckets[bucket_key], batch_size)
            yield indices
```

### DataLoader 创建

```python
# 位置: opensora/datasets/dataloader.py

def prepare_dataloader(
    dataset,
    batch_size: int = None,
    bucket_config: dict = None,
    num_workers: int = 4,
    **kwargs
):
    if bucket_config is not None:
        sampler = VariableBatchSampler(
            dataset,
            bucket_config=bucket_config,
            **kwargs
        )
        dataloader = DataLoader(
            dataset,
            batch_sampler=sampler,
            num_workers=num_workers,
            pin_memory=True,
            collate_fn=collate_fn,
        )
    else:
        # 固定 batch size 模式
        dataloader = DataLoader(
            dataset,
            batch_size=batch_size,
            shuffle=True,
            num_workers=num_workers,
        )
    return dataloader, sampler
```

## Bucket 配置详解

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              Bucket 配置示例                                         │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│   bucket_config = {                                                                 │
│       # 宽高比: 分辨率: 帧数: (采样权重, batch_size)                               │
│                                                                                     │
│       "1:1": {                              # 正方形视频                            │
│           256: {                            # 256×256 分辨率                        │
│               1: (1.0, 64),                 # 单帧(图像), bs=64                     │
│               17: (1.0, 16),                # 17帧短视频, bs=16                     │
│               65: (0.5, 4),                 # 65帧长视频, bs=4                      │
│           },                                                                        │
│           512: {                            # 512×512 分辨率                        │
│               1: (1.0, 16),                                                         │
│               17: (1.0, 4),                                                         │
│               65: (0.25, 1),                                                        │
│           },                                                                        │
│       },                                                                            │
│                                                                                     │
│       "16:9": {                             # 横版视频                              │
│           "240x426": {                      # 240p                                  │
│               17: (1.0, 8),                                                         │
│               65: (0.5, 2),                                                         │
│           },                                                                        │
│           "480x854": {                      # 480p                                  │
│               17: (0.5, 2),                                                         │
│               65: (0.25, 1),                                                        │
│           },                                                                        │
│       },                                                                            │
│                                                                                     │
│       "9:16": {                             # 竖版视频                              │
│           "426x240": {                                                              │
│               17: (1.0, 8),                                                         │
│           },                                                                        │
│       },                                                                            │
│   }                                                                                 │
│                                                                                     │
│   权重计算:                                                                         │
│   - 每个 bucket 的采样概率 = weight / sum(all_weights)                             │
│   - 权重越大的 bucket 被采样的概率越高                                              │
│   - 通常给低分辨率/短视频更高权重，训练效率更高                                     │
│                                                                                     │
│   Batch Size 选择原则:                                                              │
│   - 显存约束: tokens ∝ T × H × W                                                   │
│   - 高分辨率/长视频需要更小的 batch size                                            │
│   - 示例: 512×512×65 的 tokens 是 256×256×17 的 16 倍                              │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 数据预处理管线

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              视频预处理管线                                          │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│   原始视频文件                                                                      │
│   video.mp4 (1920×1080, 300帧, 30fps)                                              │
│        │                                                                            │
│        ▼                                                                            │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  1. 时间采样                                                                │   │
│   │     - 目标帧数: 17 (4秒 @ 4fps 的等效)                                      │   │
│   │     - 采样间隔: stride = 300 / 17 ≈ 17                                      │   │
│   │     - 帧索引: [0, 17, 34, 51, ..., 272]                                     │   │
│   │                                                                             │   │
│   │     输入: 300 帧 → 输出: 17 帧                                              │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│        │                                                                            │
│        ▼                                                                            │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  2. 空间变换 (Resize + Crop)                                                │   │
│   │                                                                             │   │
│   │     原始尺寸: 1920×1080 (16:9)                                              │   │
│   │        │                                                                    │   │
│   │        ▼ Resize (保持宽高比，短边对齐)                                      │   │
│   │     中间尺寸: 455×256                                                       │   │
│   │        │                                                                    │   │
│   │        ▼ CenterCrop                                                         │   │
│   │     目标尺寸: 256×256                                                       │   │
│   │                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│        │                                                                            │
│        ▼                                                                            │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  3. 归一化                                                                  │   │
│   │                                                                             │   │
│   │     [0, 255] (uint8)  →  [-1, 1] (float32)                                  │   │
│   │                                                                             │   │
│   │     公式: x_norm = (x / 127.5) - 1                                          │   │
│   │                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│        │                                                                            │
│        ▼                                                                            │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  4. 维度重排                                                                │   │
│   │                                                                             │   │
│   │     (T, H, W, C)  →  (C, T, H, W)                                           │   │
│   │     [17, 256, 256, 3]  →  [3, 17, 256, 256]                                 │   │
│   │                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│        │                                                                            │
│        ▼                                                                            │
│   输出 Tensor: [3, 17, 256, 256], dtype=float32, 值域=[-1, 1]                       │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 分布式数据并行

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           分布式数据加载                                             │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│   8 GPU 训练示例:                                                                   │
│                                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                          DistributedSampler                                 │   │
│   │                                                                             │   │
│   │   Total samples: 10000                                                      │   │
│   │   Num replicas: 8                                                           │   │
│   │   Samples per replica: 1250                                                 │   │
│   │                                                                             │   │
│   │   GPU 0: indices [0, 8, 16, ...]     每个 GPU 获得不重叠的样本子集          │   │
│   │   GPU 1: indices [1, 9, 17, ...]                                            │   │
│   │   GPU 2: indices [2, 10, 18, ...]                                           │   │
│   │   ...                                                                       │   │
│   │   GPU 7: indices [7, 15, 23, ...]                                           │   │
│   │                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│   Bucket Sampler + Distributed:                                                     │
│                                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                             │   │
│   │   1. 每个 GPU 独立维护 bucket 采样状态                                      │   │
│   │   2. 同步 epoch seed 保证采样顺序一致                                       │   │
│   │   3. 同一 batch 内所有 GPU 采样相同 bucket (形状一致)                       │   │
│   │                                                                             │   │
│   │   Epoch 0: GPU0=[bucket_A, bucket_B, ...], GPU1=[bucket_A, bucket_B, ...]  │   │
│   │                          ↑ 相同 bucket 顺序，不同样本                       │   │
│   │                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 预缓存数据（可选）

```python
# 预计算 VAE 和文本编码以加速训练

# 配置启用缓存
cached_video = True   # 跳过 VAE 编码
cached_text = True    # 跳过 T5/CLIP 编码

# 数据集输出变为
batch = {
    "video_latents": Tensor[B, 16, T', H', W'],  # 预计算的 VAE latent
    "text_t5": Tensor[B, L, 4096],               # 预计算的 T5 embedding
    "text_clip": Tensor[B, 768],                 # 预计算的 CLIP embedding
}
```
