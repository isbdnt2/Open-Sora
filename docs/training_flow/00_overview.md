# Open-Sora 训练流程总览

## 端到端训练流程图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              Open-Sora 训练流程                                      │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                           1. 数据加载                                        │   │
│   │                         (Data Loading)                                       │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                            │
│                                        ▼                                            │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                           2. 数据预处理                                      │   │
│   │                     视频/文本 → VAE/T5/CLIP 编码                             │   │
│   │                                                                             │   │
│   │   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                   │   │
│   │   │    Video    │     │     T5      │     │    CLIP     │                   │   │
│   │   │   [B,C,T,H,W]│     │   Encoder   │     │   Encoder   │                   │   │
│   │   └──────┬──────┘     └──────┬──────┘     └──────┬──────┘                   │   │
│   │          │                   │                   │                          │   │
│   │          ▼                   ▼                   ▼                          │   │
│   │   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                   │   │
│   │   │  VAE.encode │     │ T5 Embedding│     │CLIP Embedding│                  │   │
│   │   │   x_0       │     │     txt     │     │   y_vec     │                   │   │
│   │   └──────┬──────┘     └──────┬──────┘     └──────┬──────┘                   │   │
│   │          │                   │                   │                          │   │
│   │          └───────────────────┴───────────────────┘                          │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                            │
│                                        ▼                                            │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                        3. 噪声注入 (Flow Matching)                           │   │
│   │                                                                             │   │
│   │     x_1 ~ N(0,I)         t ~ sigmoid(randn)          x_t 加噪               │   │
│   │   ┌─────────────┐     ┌─────────────────────┐     ┌─────────────────────┐   │   │
│   │   │   随机噪声   │  +  │  时间步采样 (shifted)  │  =  │  x_t = (1-t)x_0     │   │   │
│   │   │             │     │                     │     │      + t·x_1        │   │   │
│   │   └─────────────┘     └─────────────────────┘     └─────────────────────┘   │   │
│   │                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                            │
│                                        ▼                                            │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                           4. 模型前向传播                                    │   │
│   │                                                                             │   │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │   │
│   │   │                          MMDiT Model                                │   │   │
│   │   │                                                                     │   │   │
│   │   │   Inputs:                        Output:                            │   │   │
│   │   │   - x_t (noisy latent)           - v_pred (velocity prediction)     │   │   │
│   │   │   - t (timestep)                                                    │   │   │
│   │   │   - txt (T5 embedding)                                              │   │   │
│   │   │   - y_vec (CLIP embedding)                                          │   │   │
│   │   │   - cond (I2V condition)                                            │   │   │
│   │   │                                                                     │   │   │
│   │   └─────────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                            │
│                                        ▼                                            │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                           5. 损失计算                                        │   │
│   │                                                                             │   │
│   │     v_target = (1-σ_min)·x_1 - x_0      (MovieGen velocity target)          │   │
│   │                                                                             │   │
│   │     Loss = MSE(v_pred, v_target)                                            │   │
│   │                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                            │
│                                        ▼                                            │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                           6. 反向传播与优化                                  │   │
│   │                                                                             │   │
│   │   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                   │   │
│   │   │   Backward  │ ──► │  Grad Clip  │ ──► │ Optimizer   │                   │   │
│   │   │   (loss)    │     │  (max_norm) │     │   .step()   │                   │   │
│   │   └─────────────┘     └─────────────┘     └─────────────┘                   │   │
│   │                              │                                              │   │
│   │                              ▼                                              │   │
│   │                       ┌─────────────┐                                       │   │
│   │                       │  EMA Update │                                       │   │
│   │                       │  (0.9999)   │                                       │   │
│   │                       └─────────────┘                                       │   │
│   │                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                            │
│                                        ▼                                            │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                           7. 检查点保存                                      │   │
│   │                                                                             │   │
│   │   每 ckpt_every 步保存: model, ema, optimizer, lr_scheduler, sampler        │   │
│   │                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 文档索引

| 文件 | 内容 |
|------|------|
| [01_data_loading.md](01_data_loading.md) | 数据集、Bucket采样、DataLoader |
| [02_video_encoding.md](02_video_encoding.md) | VAE 编码、I2V/V2V 条件准备 |
| [03_text_encoding.md](03_text_encoding.md) | T5/CLIP 文本编码、Dropout |
| [04_noise_injection.md](04_noise_injection.md) | Flow Matching 加噪、Time Shift |
| [05_model_forward.md](05_model_forward.md) | MMDiT 前向传播、输入打包 |
| [06_loss_backward.md](06_loss_backward.md) | 损失计算、梯度反传、EMA 更新 |

## 关键代码入口

```python
# 主训练脚本
scripts/diffusion/train.py

# 训练工具函数
opensora/utils/train.py

# 采样工具函数 (pack, prepare, prepare_ids)
opensora/utils/sampling.py
```

## 训练流程 vs 推理流程

| 阶段 | 训练 | 推理 |
|------|------|------|
| 方向 | 数据 → 噪声 (加噪) | 噪声 → 数据 (去噪) |
| 时间步 | 随机采样 t ∈ [0,1] | 从 t=1 逐步递减到 t=0 |
| 目标 | 预测 velocity v_t | 使用 v_t 更新 x_t |
| VAE | 只需 Encoder | 需要 Encoder + Decoder |
| 条件 | 真实视频条件 | 用户提供参考图/视频 |
| CFG | 无 (Dropout 实现) | 显式 CFG 采样 |

## 分布式训练架构

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           ColossalAI 分布式训练                                      │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                        Plugin 选项                                          │   │
│   │                                                                             │   │
│   │   zero1:   ZeRO Stage 1 (Optimizer State Partitioning)                      │   │
│   │   zero2:   ZeRO Stage 2 (+ Gradient Partitioning) [默认]                    │   │
│   │   hybrid:  混合并行 (TP + SP + PP + DP)                                     │   │
│   │                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                        并行策略                                             │   │
│   │                                                                             │   │
│   │   TP (Tensor Parallel):    模型参数在 GPU 间分片                            │   │
│   │   SP (Sequence Parallel):  序列在 GPU 间分片                                │   │
│   │   PP (Pipeline Parallel):  模型层在 GPU 间分片                              │   │
│   │   DP (Data Parallel):      数据在 GPU 组间复制                              │   │
│   │                                                                             │   │
│   │   num_groups = num_gpus // (tp_size * sp_size * pp_size)                    │   │
│   │                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## 核心超参数

| 参数 | 典型值 | 说明 |
|------|--------|------|
| `batch_size` | 1-4 | 每个 GPU 的 batch size |
| `accumulation_steps` | 1-8 | 梯度累积步数 |
| `lr` | 1e-4 | 学习率 |
| `warmup_steps` | 1000 | 学习率预热步数 |
| `ema_decay` | 0.9999 | EMA 衰减率 |
| `grad_clip` | 1.0 | 梯度裁剪阈值 |
| `sigma_min` | 1e-5 | Flow Matching 最小 sigma |
| `dropout_ratio.t5` | 0.3 | T5 条件 Dropout 比例 |
| `dropout_ratio.clip` | 0.3 | CLIP 条件 Dropout 比例 |
